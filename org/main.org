#+title:     MPI examples
#+author:    vijay gopal chilkuri
#+email:     chilkuri@chilkuri-MacBookPro
#+startup: showall

* Headers
#+begin_src  C :tangle (eval c) :main no
#include <stdio.h>
#include <unistd.h>
#include <mpi.h>
#include <sys/time.h>

int main(int argc, char *argv[])
{

#+end_src

* Initialize MPI
#+begin_src  C :tangle (eval c) :main no
int rank, size;
MPI_Status status;

/* Init */
MPI_Init(&argc, &argv);
MPI_Comm_rank(MPI_COMM_WORLD, &rank);
MPI_Comm_size(MPI_COMM_WORLD, &size);

#+end_src

* Probing for messages

** Slaves send messages
#+begin_src  C :tangle (eval c) :main no
if (rank != 0) { // Slaves
    int buf;

    if (rank == 1) {
        buf = 1;
        MPI_Send(&buf, 1, MPI_INT, 0, 0, MPI_COMM_WORLD);
    }
    if (rank == 1) {
        buf = 1;
        MPI_Send(&buf, 1, MPI_INT, 0, 0, MPI_COMM_WORLD);
    }
    if (rank == 2) {
        buf = 2;
        MPI_Send(&buf, 1, MPI_INT, 0, 0, MPI_COMM_WORLD);
    }
    if (rank == 2) {
        buf = 2;
        MPI_Send(&buf, 1, MPI_INT, 0, 0, MPI_COMM_WORLD);
    }
#+end_src
** Then wait to receive reply from master
#+begin_src  C :tangle (eval c) :main no
    int sum = 0;
    int flag = -1, res;
    int work = 0;
    MPI_Request request;
    MPI_Status status;
    while (1) {
        if(flag != 0)
        {
            MPI_Irecv(&res, 1, MPI_INT, MPI_ANY_SOURCE, MPI_ANY_TAG, MPI_COMM_WORLD, &request);
            flag = 0;
        }

        //if (work > 3){
          MPI_Test(&request, &flag, &status);
        //}

        if (flag != 0) {
            if (status.MPI_SOURCE != -1)
                sum += res;
            printf("recv : %d, master : %d sum=%d\n", res, status.MPI_SOURCE,sum);
            flag = -1;
        }

        work++;

        if (sum == 1)
            break;
    }
    sleep(2.0);

    //MPI_Send(&work, 1, MPI_INT, 0, 0, MPI_COMM_WORLD);

    printf("done rank = %d sum : %d work = %d\n", rank, sum, work);
}
#+end_src
** Master probes for messages and receives
#+begin_src  C :tangle (eval c) :main no
else { // Master
    int sum = 0;
    int flag = -1, res;
    MPI_Request request;
    MPI_Status status;
    while (1) {
        if(flag != 0)
        {
            MPI_Irecv(&res, 1, MPI_INT, MPI_ANY_SOURCE, MPI_ANY_TAG, MPI_COMM_WORLD, &request);
            flag = 0;
        }

        MPI_Test(&request, &flag, &status);

        if (flag != 0) {
            if (status.MPI_SOURCE != -1)
                sum += res;
            flag = -1;
            printf("recv : %d, slave : %d sum = %d\n", res, status.MPI_SOURCE,sum);
        }


        if (sum == 6)
            break;
    }
    //sleep(4.0);
#+end_src
** Master sends reply to slaves
#+begin_src  C :tangle (eval c) :main no
    int buf;
    buf=1;
    MPI_Send(&buf, 1, MPI_INT, 1, 0, MPI_COMM_WORLD);
    buf=1;
    MPI_Send(&buf, 1, MPI_INT, 2, 0, MPI_COMM_WORLD);
    
    //MPI_Recv(&buf, 1, MPI_INT, 1, 0, MPI_COMM_WORLD, &status);
    //printf("res from 1 : %d\n", buf);
    //MPI_Recv(&buf, 1, MPI_INT, 2, 0, MPI_COMM_WORLD, &status);
    //printf("res from 2 : %d\n", buf);

    printf("sum : %d\n", sum);
}
#+end_src
* End
#+begin_src  C :tangle (eval c) :main no

MPI_Finalize();
return 0;

}
#+end_src
